<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì–´ì¢…í™•ì¸ - ì‚¬ì§„ì´¬ì˜</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .phone-screen {
            background-color: #0B5383;
            padding-bottom: 0;
            box-sizing: border-box;
        }
        .camera-view {
            width: 91.8%;
            max-width: 358px;
            height: 536px;
            margin-top: 111px;
            background-color: rgba(0, 0, 0, 0.33);
            position: relative;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        #camera-feed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        .camera-view::before,
        .camera-view::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            z-index: 5;
        }
        .camera-view::before {
            top: 33.33%;
            height: 33.33%;
            border-top: 1px solid rgba(255, 255, 255, 0.4);
            border-bottom: 1px solid rgba(255, 255, 255, 0.4);
        }
        .camera-view::after {
            left: 33.33%;
            width: 33.33%;
            border-left: 1px solid rgba(255, 255, 255, 0.4);
            border-right: 1px solid rgba(255, 255, 255, 0.4);
        }
        .shutter-button-container {
            margin-top: 24px;
            position: relative;
            width: 72px;
            height: 72px;
            cursor: pointer;
        }
        .shutter-outer-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: white;
        }
        .shutter-inner-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: white;
            border: 3px solid #0EA5E9;
            box-sizing: border-box;
        }
        .back-button {
            color: white;
            cursor: pointer;
            z-index: 20;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            margin-right: 10px;
        }
        .header-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            width: calc(100% - 40px);
            display: flex;
            align-items: center;
            z-index: 20;
        }
        .header-title {
            color: white;
            font-size: 18px;
            font-weight: bold;
        }
        .back-arrow-icon {
            width: 24px;
            height: 24px;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            min-height: 50px;
            display: none;
            width: 91.8%;
            max-width: 358px;
        }
        #result.success {
            background-color: #E3F2FD;
            color: #1976D2;
            display: block;
        }
        #result.error {
            background-color: #FFEBEE;
            color: #C62828;
            display: block;
        }
        #result.loading {
            background-color: #FFF3E0;
            color: #E65100;
            display: block;
        }
    </style>
</head>
<body>
    <div class="phone-screen">
        <div class="header-controls">
            <div class="back-button" onclick="window.location.href='index.html'">
                <svg class="back-arrow-icon" viewBox="0 0 24 24">
                    <path d="M15 5 L5 12 L15 19 M5 12 H20" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <span class="header-title">ì–´ì¢…í™•ì¸ - ì‚¬ì§„ì´¬ì˜</span>
        </div>
        <div class="camera-view">
            <video id="camera-feed" autoplay playsinline></video>
        </div>
        <div class="shutter-button-container" id="shutter-btn">
            <div class="shutter-outer-circle"></div>
            <div class="shutter-inner-circle"></div>
        </div>
        <div id="result"></div>
    </div>

    <script>
        const cameraFeed = document.getElementById('camera-feed');
        const shutterBtn = document.getElementById('shutter-btn');
        const resultDiv = document.getElementById('result');
        let stream = null;

        // ì¹´ë©”ë¼ ìë™ ì ‘ê·¼
        async function initCamera() {
            try {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    cameraFeed.srcObject = stream;
                    cameraFeed.play();
                } else {
                    showError('í˜„ì¬ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì¹´ë©”ë¼ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            } catch (err) {
                console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜:', err);
                showError('ì¹´ë©”ë¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }

        // ì´¬ì˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        shutterBtn.addEventListener('click', async () => {
            try {
                // ì´ë¯¸ì§€ ìº¡ì²˜
                const canvas = document.createElement('canvas');
                canvas.width = cameraFeed.videoWidth;
                canvas.height = cameraFeed.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);

                // Blobìœ¼ë¡œ ë³€í™˜ (JPEG)
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        showError('ì´ë¯¸ì§€ ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        return;
                    }

                    // ë¡œë”© í‘œì‹œ
                    showLoading('ë¶„ì„ ì¤‘...');

                    // ì„œë²„ë¡œ ì „ì†¡
                    const apiEndpoint = '/api/predict';
                    console.log('ğŸ“¡ API Endpoint:', apiEndpoint);
                    console.log('ğŸ“¡ Full URL:', window.location.origin + apiEndpoint);
                    
                    try {
                        const response = await fetch(apiEndpoint, {
                            method: 'POST',
                            body: blob
                        });

                        if (!response.ok) {
                            const error = new Error(`HTTP error! status: ${response.status}`);
                            error.status = response.status;
                            throw error;
                        }

                        const data = await response.json();
                        handlePredictionResult(data);
                    } catch (error) {
                        console.error('ì˜ˆì¸¡ ìš”ì²­ ì˜¤ë¥˜:', error);
                        if (error.status === 500) {
                            showError('ì˜ˆì¸¡ ì‹¤íŒ¨ (ì„œë²„ ì˜¤ë¥˜) â€“ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”');
                        } else if (error.status === 404) {
                            showError('ì˜ˆì¸¡ API ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (404) â€“ ë°°í¬ êµ¬ì„±ì„ í™•ì¸í•´ì£¼ì„¸ìš”');
                        } else {
                            showError('ì˜ˆì¸¡ ì‹¤íŒ¨ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
                        }
                    }
                }, 'image/jpeg', 0.9);
            } catch (error) {
                console.error('ì´¬ì˜ ì˜¤ë¥˜:', error);
                showError('ì´¬ì˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // ì˜ˆì¸¡ ê²°ê³¼ ì²˜ë¦¬
        function handlePredictionResult(data) {
            if (!data.predictions || data.predictions.length === 0) {
                showError('ì¸ì‹ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì´¬ì˜í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ê°€ì¥ ë†’ì€ í™•ë¥ ì˜ ì˜ˆì¸¡ê°’ ì°¾ê¸°
            const topPrediction = data.predictions[0];
            const probability = topPrediction.probability;
            const tagName = topPrediction.tagName;

            // í™•ë¥ ì„ í¼ì„¼íŠ¸ë¡œ ë³€í™˜
            const probabilityPercent = (probability * 100).toFixed(1);

            if (probability < 0.7) {
                // 70% ë¯¸ë§Œ
                showError(`ì¸ì‹ ì‹¤íŒ¨ â€“ ë‹¤ì‹œ ì´¬ì˜í•´ì£¼ì„¸ìš” (${tagName}: ${probabilityPercent}%)`);
            } else {
                // 70% ì´ìƒ
                showSuccess(`${tagName}: ${probabilityPercent}%`);
            }
        }

        // ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜ë“¤
        function showLoading(message) {
            resultDiv.className = 'loading';
            resultDiv.textContent = message;
        }

        function showSuccess(message) {
            resultDiv.className = 'success';
            resultDiv.textContent = message;
        }

        function showError(message) {
            resultDiv.className = 'error';
            resultDiv.textContent = message;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¹´ë©”ë¼ ì´ˆê¸°í™”
        initCamera();

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
